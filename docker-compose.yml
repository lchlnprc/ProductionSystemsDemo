services:
  python-tester:
    build:
      context: ./python-tester
      dockerfile: Dockerfile
    image: production-systems/python-tester:latest
    environment:
      SERIAL_PORT: socket://host.docker.internal:4000
      API_BASE_URL: ${API_BASE_URL:-http://host.docker.internal:8080/api}
      DEVICE_ID: ${DEVICE_ID:-DEVICE_001}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./python-tester/test-results:/app/test-results
    command: ["python", "-m", "src.cli"]

  python-tester-agent:
    build:
      context: ./python-tester
      dockerfile: Dockerfile
    image: production-systems/python-tester:latest
    environment:
      SERIAL_PORT: socket://host.docker.internal:4000
      API_BASE_URL: http://backend:8080/api
      DEVICE_ID: ${DEVICE_ID:-DEVICE_001}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./python-tester/test-results:/app/test-results
    command: ["python", "-m", "src.cli", "--poll"]

  backend:
    build:
      context: ./backend/spring-api
      dockerfile: Dockerfile
    image: production-systems/spring-api:latest
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/production_systems
      DB_USER: postgres
      DB_PASSWORD: postgres
      SERVER_PORT: 8080
    ports:
      - "8080:8080"
    depends_on:
      - postgres

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: production_systems
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  frontend:
    build:
      context: ./frontend/react-dashboard
      dockerfile: Dockerfile
    image: production-systems/react-dashboard:latest
    environment:
      VITE_API_BASE_URL: /api
    ports:
      - "5173:80"
    depends_on:
      - backend

volumes:
  postgres_data: